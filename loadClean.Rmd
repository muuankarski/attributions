% Loading and cleaning the data

- [back to index](index.html)


`generated at:`
```{r, echo=FALSE}
Sys.time()
```
---


<link href="http://markuskainu.fi/material/css/rmarkdown.css" rel="stylesheet" type="text/css" title="compact"></link> 


```{r, eval=FALSE, echo=FALSE}
setwd("~/workspace/lits/attrib/attrib_year2013/")
library(kaRski)
knitpandoc("loadClean")
```


```{roptsattrib, echo=FALSE}
opts_chunk$set(echo=TRUE,eval=TRUE, cache=FALSE,message=FALSE,warning=FALSE,fig.width=12,fig.height=12)
```

# Loading the data from EBRD


```{rLoadClean1}
# FROM WEB
#temp <- tempfile()
#download.file("http://www.ebrd.com/downloads/research/surveys/lits2.dta", temp)
#library(foreign)
#lits2 <- read.dta(temp)

# FROM LOCAL DISK
load("~/workspace/data/lits/lits2.RData")
```


# Munging the data

## Country names & groupings

```{rLoadClean2}
# different country groupings
## remove whitespaces from country
library(stringr)
lits2$cntry <- str_trim(lits2$country_, side="right")
lits2$cntry <- factor(lits2$cntry)

lits2$socialism[lits2$cntry %in% c('France','Germany','Great Britain',
                                   'Italy','Sweden')]                   <- 'Market economy'

lits2$socialism[lits2$cntry %in% c('Czech Republic','Estonia','Hungary',
                                   'Bulgaria','Latvia','Lithuania',
                                   'Poland','Slovakia','Slovenia',
                                   'Romania','Albania','Bosnia',
                                   'Bulgaria','Croatia','Macedonia',
                                   'Montenegro','Kosovo','Serbia',
                                   'Armenia','Azerbaijan','Belarus',
                                   'Georgia','Kazakhstan','Kyrgyzstan',
                                   'Moldova','Mongolia','Russia',
                                   'Tajikistan','Ukraine','Uzbekistan')] <- 'Post-socialist'

summary(factor(lits2$socialism))

lits2$group_analysis[lits2$cntry %in% c('France','Germany',
                                        'Great Britain',
                                        'Italy','Sweden')] <- 'Western Europe'

lits2$group_analysis[lits2$cntry %in% c('Czech Republic','Estonia',
                                        'Hungary','Bulgaria',
                                        'Latvia','Lithuania',
                                        'Poland','Slovakia',
                                        'Slovenia','Romania')] <- 'CEE'

lits2$group_analysis[lits2$cntry %in% c('Armenia','Azerbaijan',
                                        'Belarus','Georgia',
                                        'Kazakhstan','Kyrgyzstan',
                                        'Moldova','Tajikistan',
                                        'Ukraine','Uzbekistan','Russia')] <- 'CIS'

summary(factor(lits2$group_analysis))

```

## Recoding the dependent variable

```{rLoadClean3}
summary(lits2$q309)
# reason for poverty
library(stringr)
lits2$q309 <- as.factor(str_replace(lits2$q309, 
                                    "Don't know", 
                                    "Dont know"))
# All options
lits2$q309 <- as.character(lits2$q309)
lits2$q309[lits2$q309 %in% 'Because of injustice in our society'] <- 'Social Blame'
lits2$q309[lits2$q309 %in% 'Because of laziness and lack of willpower'] <- 'Individual Blame'
lits2$q309[lits2$q309 %in% 'Because they have been unlucky'] <- 'Individual Fate'
lits2$q309[lits2$q309 %in% 'It is an inevitable part of modern life'] <- 'Social Fate'
lits2$q309[lits2$q309 %in% 'Not stated'] <- 'Not stated'
lits2$q309[lits2$q309 %in% 'Dont know'] <- 'Dont know'

lits2$q309 <- factor(lits2$q309, levels=c("Social Blame",
                                          "Individual Blame",
                                          "Individual Fate",
                                          "Social Fate",
                                          "Not stated",
                                          "Dont know"))

summary(lits2$q309)
# not stated and dont know coded NA

lits2$poverty <- lits2$q309
lits2$poverty[lits2$poverty %in% c('Not stated','Dont know')] <- NA
lits2$poverty <- factor(lits2$poverty)
summary(lits2$poverty)

## For logistic regressions
# $pov.log.social

lits2$pov.log.social[lits2$q309 == 'Social Blame'] <- 1
lits2$pov.log.social[lits2$q309 != 'Social Blame'] <- 0

summary(factor(lits2$pov.log.social))

# $pov_log_individual
###

lits2$pov.log.individual[lits2$q309 == 'Individual Blame'] <- 1
lits2$pov.log.individual[lits2$q309 != 'Individual Blame'] <- 0

summary(factor(lits2$pov.log.individual))

```

## Independent variables

```{rLoadClean4}
# $sex
lits2$sex <- lits2$q102_1
# $income

lits2$income[lits2$q227 >= 1 & lits2$q227 <= 3]  <- 'Low income'
lits2$income[lits2$q227 >= 4 & lits2$q227 <= 7]  <- 'Middle income'
lits2$income[lits2$q227 >= 8] <-'High income'

lits2$income <- factor(lits2$income, 
                       levels=c("Low income",
                                "Middle income",
                                "High income"))

summary(lits2$income)

lits2$income2[lits2$q227 >= 1 & lits2$q227 <= 5]  <- 'Low'
lits2$income2[lits2$q227 >= 6 & lits2$q227 <= 10]  <- 'High'

lits2$income2 <- factor(lits2$income2, 
                       levels=c("Low",
                                "High"))

summary(lits2$income2)

# median(lits2)
#svyquantile(~q227, d.df, quantile = c(0.25, 0.5, 0.75), ci = TRUE)
library(car)
lits2$q227_rec <- lits2$q227
lits2$q227_rec[lits2$q227_rec <= 0] <- NA
# $future
###

summary(factor(lits2$q229))

lits2$future[lits2$q229 >= 1 & lits2$q229 <= 3] <- "low income"
lits2$future[lits2$q229 >= 4 & lits2$q229 <= 7] <- "middle income"
lits2$future[lits2$q229 >= 8 & lits2$q229 <= 10] <- "high income"

summary(factor(lits2$future))

lits2$q229_rec <- lits2$q229
lits2$q229_rec[lits2$q229_rec <= 0] <- NA

summary(factor(lits2$q229_rec))

lits2$future.diff[lits2$q227_rec > lits2$q229_rec] <- 'worse'
lits2$future.diff[lits2$q227_rec <= lits2$q229_rec] <- 'same or better'
lits2$future.diff <- factor(lits2$future.diff, levels=c("worse",
                                                        "same or better"))

summary(lits2$future.diff)
# $past
###

summary(factor(lits2$q228))

lits2$past[lits2$q228 >= 1 & lits2$q228 <= 3] <- "low income"
lits2$past[lits2$q228 >= 4 & lits2$q228 <= 7] <- "middle income"
lits2$past[lits2$q228 >= 8 & lits2$q228 <= 10] <- "high income"

summary(factor(lits2$past))

lits2$q228_rec <- lits2$q228
lits2$q228_rec[lits2$q228_rec <= 0] <- NA

summary(factor(lits2$q228_rec))

lits2$past.diff[lits2$q227_rec < lits2$q228_rec] <- 'worse'
lits2$past.diff[lits2$q227_rec >= lits2$q228_rec] <- 'same or better'
lits2$past.diff <- factor(lits2$past.diff, levels=c("worse",
                                                    "same or better"))
# $age
###

lits2$ageclass[lits2$q104a_1 <= 29] <- '29 or younger'
lits2$ageclass[lits2$q104a_1 >= 30 & lits2$q104a_1 <= 44] <- '30 to 44'
lits2$ageclass[lits2$q104a_1 >= 45 & lits2$q104a_1 <= 59] <- '45 to 59'
lits2$ageclass[lits2$q104a_1 >= 60 & lits2$q104a_1 <= 120] <- '60 and older'

lits2$ageclass <- factor(lits2$ageclass, 
                         levels=c("29 or younger",
                                  "30 to 44",
                                  "45 to 59",
                                  "60 and older"))

summary(lits2$ageclass)

lits2$age <- lits2$q104a_1

###

# $incsour tulonlähde
###
summary(factor(lits2$q226m))

lits2$incsour3[lits2$q226m == 5 | lits2$q226m == 6] <- "dependent"
lits2$incsour3[lits2$q226m > 0 & lits2$q226m < 5 | lits2$q226m > 6 ] <- "notDependent"

lits2$incsour3 <- factor(lits2$incsour3, 
                         levels=c("dependent",
                                  "notDependent"))
summary(lits2$incsour3)
###

# $edu
###

summary(factor(lits2$q515))

lits2$edu2[lits2$q515 == 1 | lits2$q515 == 2]  <- "no or compulsory"
lits2$edu2[lits2$q515 >= 3]  <- "higher"
  
lits2$edu2 <- factor(lits2$edu2,
                     levels=c("no or compulsory",
                              "higher"))

summary(lits2$edu2)
#################
# $crise - kriisikokemus
#################
library(stringr)
lits2$q801 <- as.factor(str_replace(lits2$q801, "Don't know", "DONT KNOW"))

summary(lits2$q801)

lits2$q801 <- factor(lits2$q801, 
                     levels=c("A GREAT DEAL",
                              "A FAIR AMOUNT",
                              "JUST A LITTLE",
                              "NOT AT ALL",
                              "DONT KNOW",
                              "Refused"))

lits2$crise[lits2$q801 %in% c('A GREAT DEAL','A FAIR AMOUNT')] <- 'Great or fair amount'
lits2$crise[lits2$q801 %in% c('NOT AT ALL','JUST A LITTLE')] <- 'Little or not at all'

lits2$crise <- factor(lits2$crise, levels=c("Great or fair amount",
                                            "Little or not at all"))
summary(lits2$crise)
```

# Subsetting data for analysis

```{rLoadClean5, eval=TRUE}
## Data for the analysis
df <- subset(lits2, select=c("SerialID","weight","cntry","country0","q309",
                             "sex",
                             "ageclass","age",
                             "future.diff","past.diff",
                             "pov.log.social",
                             "pov.log.individual",
                             "socialism","incsour3",
                             "edu2",
                             "group_analysis",
                             #"group_general","group_fine",
                             "income2",
                             "crise",
                             "q227", # income
                             "q228", # menneisyys
                             "q229", # tulevaisuus
#                             "q226m_txt", # tulonlähde
                             "q515", # edu
                             "q801", # crise,
                             "poverty"
                             ))
# filter out not wanted countries
df <- df[!is.na(df$group_analysis),] # valitaan vaan group1 -muuttujan maat
df$cntry <- factor(df$cntry)
summary(df)

```

# Macro level data

## Summarising micro data at the country level

```{rLoadClean6, eval=TRUE}
###
library(reshape2)
library(survey)
d.df <- svydesign(id = ~SerialID, 
                  weights = ~weight, 
                  data = df)

summary309 <- data.frame(prop.table(svytable(~q309 + 
                                               cntry, d.df), 
                                    2) * 100)

summary309 <- summary309[!is.na(summary309$Freq), ]
summary309w <- dcast(summary309, 
                     cntry ~ q309, 
                     value.var="Freq")
names(summary309w) <- c("cntry","socialBlame",
                        "individualBlame","individualFate",
                        "socialFate","not.stated","dont.know")

summaryPoverty <- data.frame(prop.table(svytable(~poverty + 
                                                   cntry, d.df), 
                                        2) * 100)
summaryPoverty <- summaryPoverty[!is.na(summaryPoverty$Freq), ]

summaryPovertyw <- dcast(summaryPoverty, cntry ~ poverty, value.var="Freq")
names(summaryPovertyw) <- c("cntry","socialBlame","individualBlame","individualFate","socialFate")

```

## Data from Quality of Government institute

```{rLoadClean7, eval=TRUE}
#######
# Quality of governance
library(rustfare)
datQog <- GetQog(country = c('Armenia','Azerbaijan','Georgia','Russia',
                   'Ukraine','Moldova','Belarus','Kyrgyzstan',
                   'Kazakhstan','Tajikistan',
                   'Uzbekistan','Estonia','Latvia','Lithuania',
                   'Poland','Czech Republic','Slovakia','Hungary',
                   'Slovenia','Romania','Bulgaria',
                   'Italy','Germany','United Kingdom',
                   'Sweden','France'), 
       indicator = c("ffp_fsi", # Failed States Index
                     "wbgi_vae", # World Bank - Voice and Accountability
                     "undp_hdi", # UNDP Human Development Index
                     "fh_polity2", # Democracy (Freedom House/Polity)
                     "uw_gini"))
# subset the latest value per cntry per indicator
library(plyr)
datQogSum <- ddply(datQog, c("cname","indicator"), 
                   subset, year == max(year))

# library(ggplot2)
# ggplot(datQogSum, aes(x=year,y=value,color=cname)) + 
#   geom_point(size=4) +
#   geom_text(data = datQogSum,
#             aes(x=year,y=value,
#                 color=cname,
#                 label=cname),
#             size=3.5) +
#   facet_wrap(~indicator, scales="free") +
#   theme(legend.position="none")

datQogSum.w <- dcast(datQogSum, 
                     cname ~ indicator, 
                     value.var="value")

datQogSum.w$cname <-  as.character(datQogSum.w$cname)
datQogSum.w$cname[datQogSum.w$cname %in% "United Kingdom"] <- "Great Britain"

datQogSum.w$group_fine[datQogSum.w$cname %in% c('Armenia','Azerbaijan','Georgia')] <- 'Caucasus'
datQogSum.w$group_fine[datQogSum.w$cname %in% c('Russia','Ukraine','Moldova','Belarus')] <- 'CIS North'
datQogSum.w$group_fine[datQogSum.w$cname %in% c('Kyrgyzstan','Kazakhstan','Tajikistan','Uzbekistan')] <- 'Central Asia'
datQogSum.w$group_fine[datQogSum.w$cname %in% c('Estonia','Latvia','Lithuania')] <- 'Baltic States'
datQogSum.w$group_fine[datQogSum.w$cname %in% c('Poland','Czech Republic','Slovakia','Hungary',
                                                'Slovenia','Romania','Bulgaria')] <- 'CEE EU'
datQogSum.w$group_fine[datQogSum.w$cname %in% c('Italy','Germany','Great Britain','Sweden','France')] <- 'West Europe'
                         
datQogSum.w$group_fine <- factor(datQogSum.w$group_fine)

summary(factor(datQogSum.w$group_fine))

datQogSum.w$group_general[datQogSum.w$cname %in% c('France','Germany',
                                                   'Great Britain','Italy','Sweden')] <- 'Western Europe'
datQogSum.w$group_general[datQogSum.w$cname %in% c('Czech Republic','Estonia',
                                                   'Hungary','Bulgaria',
                                                   'Latvia','Lithuania','Poland',
                                                   'Slovakia','Slovenia','Romania')] <- 'CEE'
datQogSum.w$group_general[datQogSum.w$cname %in% c('Armenia','Azerbaijan','Belarus',
                                                   'Georgia','Kazakhstan',
                                                   'Kyrgyzstan','Moldova',
                                                   'Tajikistan','Ukraine',
                                                   'Uzbekistan','Russia')] <- 'CIS'

datQogSum.w$group_general <- factor(datQogSum.w$group_general)

df.qog <- datQogSum.w
# underschores into dots for latex...
#names <- names(df.qog)
#library(stringr)
#names <- str_replace_all(names, "_",".")
#names(df.qog) <- names
names(df.qog)[1] <- "cntry"
```

## Data from World Bank

```{rLoadClean8, eval=TRUE}
## GDP change from WB
### We need iso2c countrycode
library(countrycode)
cntry <- levels(df$cntry) # countrynames
iso2c <- countrycode(cntry, "country.name", "iso2c")
iso2c # copy paste into WDI search
library(WDI)
# WDIsearch(string='gdp', field='name', cache=NULL)
wb <- WDI(indicator = c("NY.GDP.MKTP.CD"), 
          country = c("AL","AM","AZ","BY","BA","BG","HR",
                      "CZ","EE","FR","GE","DE","GB","HU",
                      "IT","KZ","KG","LV","LT","MK","MD",
                      "MN","ME","PL","RO","RU","RS","SK",
                      "SI","SE","TJ","TR","UA","UZ"), 
           start = 2007, end = 2010)

library(reshape2)
names(wb) <- c("iso2c","cntry","var","year")
wb.w <- dcast(wb, 
              cntry ~ year, 
              value.var="var")

names(wb.w) <- c("cntry","x2007","x2008","x2009","x2010")
wb.w$gdpchange07.10 <- wb.w$x2010/wb.w$x2007 * 100 - 100
gdp <- wb.w[,c(1,6)]

gdp$cntry[gdp$cntry == 'Russian Federation'] <- 'Russia'
gdp$cntry[gdp$cntry == 'Kyrgyz Republic'] <- 'Kyrgyzstan'
gdp$cntry[gdp$cntry == 'United Kingdom'] <- 'Great Britain'
gdp$cntry[gdp$cntry == 'Slovak Republic'] <- 'Slovakia'

```

## Merging all the data and saving for the analysis

```{rLoadClean9}

# yhdistetään nää aikaisempien datojen kanssa
macro <- merge(summary309w,gdp,by="cntry", all.x=TRUE)
macro <- merge(macro,df.qog,by="cntry")

df <- merge(df,macro,by="cntry")

rm(lits2)
rm(df.qog)
rm(df.cross.postsoc)
rm(gdp)
rm(t3)
rm(summary309)
rm(summary309_rec)
rm(d.df)
rm(wb)
rm(wb.w)
rm(cntry)
rm(iso2c)

save.image("~/workspace/lits/attrib/attrib_year2013/data/lits.RData")
#load("~/workspace/lits/attrib/attrib_year2013/data/lits.RData")
```


